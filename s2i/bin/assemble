#!/bin/bash -e
source /opt/app-root/etc/node_environment

if [ -d /tmp/artifacts/ ]; then
    echo "---> Restoring build artifacts..."
    mv -v /tmp/artifacts/* ./
fi

echo -e "Environment: \n\tNODE_ENV=${NODE_ENV}"
echo "---> Installing application source ..."
mv /tmp/src/* ./

# Change the npm registry mirror if provided
if [[ ${NPM_MIRROR:+1} ]]; then
	npm config set registry $NPM_MIRROR
fi

if [ -f "yarn.lock" ]; then
	# npm is an alias
	echo "---> Building your Node application from source (yarn)"
	npm install --pure-lockfile --ignore-engines
else
	echo "---> Building your Node application from source (npm)"
	npm install
fi

# Fix source directory permissions
fix-permissions ./
